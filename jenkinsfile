pipeline {
  agent any

  options {
    timestamps()
  }

  environment {
    PNPM_VERSION = "10.9.0"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Setup Node') {
      steps {
        bat """
          echo ===== Node and npm =====
          node -v
          npm -v
        """
      }
    }

    stage('Install dependencies') {
        steps {
            bat "echo ===== pnpm via npx (no corepack) ====="
            bat "npx -y pnpm@%PNPM_VERSION% --version"

            bat "echo ===== Installing workspace deps ====="
            bat "npx -y pnpm@%PNPM_VERSION% install --frozen-lockfile"

            bat "echo ===== Turbo version ====="
            bat """
            if exist node_modules\\.bin\\turbo.cmd (
                node_modules\\.bin\\turbo.cmd --version
            ) else (
                echo turbo not found in node_modules\\.bin
                exit /b 1
            )
            """
        }
    }


    stage('Build') {
      steps {
        bat """
          echo ===== Build =====
          npx -y pnpm@%PNPM_VERSION% build
        """
      }
    }
  }

  post {
    always {
      echo "Done."
    }
  }
}
